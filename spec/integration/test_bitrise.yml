format_version: "8"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: ios
app:
  envs:
  - ACCESS_KEY: "120"
  - GITHUB_TOKEN: GITHUB_TOKEN
    opts:
      is_expand: false
  - SLACK_WEBHOOK: https://tempuri.org
trigger_map:
- push_branch: master
  workflow: wf1
- push_branch: release
  workflow: wf2
- pull_request_target_branch: '*'
  workflow: wf3
workflows:
  wf1:
    envs:
    - TEST: test
      opts:
        is_expand: false
    steps:
    - github-status@2.2.2:
        inputs:
        - api_base_url: https://github.com
        - set_specific_status: pending
        - auth_token: $GITHUB_TOKEN
    - script@1.1.5:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x

            # write your script here
            git config --global user.name "Bitrise"
    - activate-ssh-key: {}
    - certificate-and-profile-installer@1.10.2: {}
    - authenticate-host-with-netrc@0.9.4:
        inputs:
        - username: $username
        - password: $PAT
        - host: github.com
    - script@1.1:
        title: Install Swiftlint 0.35
        inputs:
        - content: |
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x

            # Installing Swiftlint 0.35.0
            brew install https://raw.githubusercontent.com/Homebrew/homebrew-core/a150ab2162228b957db1871947315f2278b21252/Formula/swiftlint.rb
    - git-clone@4.0.17:
        inputs:
        - clone_depth: "0"
    - cache-pull@2.1.3: {}
    - cache-pull@2: {}
    - authenticate-with-github-oauth@0: {}
    - cache-pull@2.1: {}
    - fastlane@2.6:
        title: Carthage Bootstrap
        asset_urls:
          icon.png: https://bitrise-steplib-collection.s3.amazonaws.com/steps/fastlane/assets/icon.png
        inputs:
        - lane: download_carthage_from_artifactory
    - deploy-to-itunesconnect-application-loader: {}
    - fastlane-match@0.2:
        title: Fastlane Match Development
        inputs:
        - git_branch: master
    - carthage@3.2.1:
        inputs:
        - carthage_options: --platform ios --cache-builds
        - github_access_token: $GITHUB_TOKEN
    - xcode-build-for-test:
        inputs:
        - scheme: $SCHEME_UI_TESTS
        - project_path: $WORKSPACE_UI_TESTS
    - virtual-device-testing-for-ios@0.9:
        inputs:
        - test_devices: iphonexsmax,12.1,en,portrait
    - deploy-to-bitrise-io@1.7.1: {}
    - cache-push@2:
        inputs:
        - ignore_check_on_paths: '!./Pods'
        - cache_paths: ./Carthage -> ./Carthage/Cachefile
    - slack@3:
        inputs:
        - channel: '#test'
        - channel_on_error: '#test-error'
        - text_on_error: Oh No!
        - emoji_on_error: ':white_frowning_face:'
        - pretext_on_error: '*Failed Bro*'
        - emoji: ':smile:'
        - author_name: Bitrise
        - fields: |
            App|${BITRISE_APP_TITLE}
            Branch|${BITRISE_GIT_BRANCH}
            Workflow|${BITRISE_TRIGGERED_WORKFLOW_ID}
        - webhook_url: $SLACK_WEBHOOK
  wf2:
    before_run:
    - wf1
    envs:
    - opts:
        is_expand: false
      project: test
    steps:
    - build-router-start@0.11.3:
        inputs:
        - workflows: |-
            wf3
            wf4
        - environment_key_list: ""
    - build-router-wait@0.9.1:
        inputs:
        - access_token: $ACCESS_KEY
  wf3:
    after_run:
    - wf1
    - wf2
    envs:
    - opts:
        is_expand: false
      project: vrbo
